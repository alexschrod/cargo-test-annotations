name: "Cargo Test Annotations"
author: "Alexander Krivács Schrøder <alexschrod@gmail.com>"
description: "Parse Cargo test output and generate GitHub Actions annotations for them in the source code"
inputs:
    metadata:
        description: "Path to metadata.json from running `cargo metadata --format-version 1 > metadata.json`"
        required: true
    tests:
        description: "Path to tests.json generated from running one or more `cargo test`s"
        required: true
    token:
        description: "The `GITHUB_TOKEN` secret of the workflow instance"
        required: true
    name:
        description: Display name of the created GitHub Check Run. Must be unique across several Cargo Test Annotations invocations for a given workflow event.
        default: cargo-test-annotations
runs:
    using: "composite"
    steps:
        - name: Cache executable
          id: cache-executable
          uses: actions/cache@v3
          with:
              path: ~/.cargo/bin/cargo-test-annotations*
              key: ${{ runner.os }}-build-${{ hashFiles('**/Cargo.toml', '**/*.rs') }}

        - name: Install ourselves
          uses: actions-rs/cargo@v1
          with:
              command: install
              args: --path ${{ github.action_path }}

        - name: Run ourselves
          uses: actions-rs/cargo@v1
          env:
              # Pass our inputs on because GitHub won't do it since we're not
              # a node.js action.
              INPUT_METADATA: ${{ inputs.metadata }}
              INPUT_TESTS: ${{ inputs.tests }}
              INPUT_TOKEN: ${{ inputs.token }}
              INPUT_NAME: ${{ inputs.name }}
          with:
              command: test-annotations

branding:
    icon: flag
